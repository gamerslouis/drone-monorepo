kind: pipeline
type: kubernetes
name: Docker build

trigger:
  paths:
    include:
      - code/*

steps:
  - name: version
    image: alpine
    commands:
      - printf "`cat code/VERSION`,latest" > .tags

  - name: build
    image: registry.192.168.178.48.nip.io/drone-kaniko
    settings:
      username: tiago
      password: empty
      repo: registry-docker-registry.tools.svc.cluster.local:5000/drone-monorepo
      registry: registry-docker-registry.tools.svc.cluster.local:5000/
      dockerfile: ./code/Dockerfile
      context: ./code
---
kind: pipeline
type: kubernetes
name: Chart build

trigger:
  paths:
    include:
      - "chart/*"

steps:
- name: Package and push chart
  image: registry.192.168.178.48.nip.io/helm-build:latest
  commands:
    - helm lint chart/
    - helm package chart/
    - curl -X POST --data-binary @drone-monorepo-`cat chart/Chart.yaml | grep "version:" | cut -d " " -f 2`.tgz -k https://charts.tiagoposse.com/api/charts
