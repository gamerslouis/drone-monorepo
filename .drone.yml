kind: pipeline
type: kubernetes
name: Docker build

platform:
  os: linux
  arch: arm

trigger:
  branch:
  - main

build: &build
  name: build
  image: registry.tiagoposse.com/kaniko-arm:1.2.0
  commands:
    - printf "`cat code/VERSION`,latest" > .tags
    - /kaniko/executor --dockerfile=./code/Dockerfile --context=code  --cache=true --cache-repo=registry.tiagoposse.com/drone-monorepo --destination=registry.tiagoposse.com/drone-monorepo

steps:
  - <<: *build
    when:
      paths:
        - code/VERSION

  - <<: *build
    when:
      event: custom
---
kind: pipeline
type: kubernetes
name: Chart build

trigger:
  paths:
    include:
      - "chart/*"
  branch:
  - main

platform:
  os: linux
  arch: arm

steps:
- name: Package and push chart
  image: registry.tiagoposse.com/cluster-droid:0.5.7
  commands:
    - helm lint chart/
    - helm package chart/
    - curl -X POST --data-binary @drone-monorepo-`cat chart/Chart.yaml | grep "version:" | cut -d " " -f 2`.tgz -k https://charts.tiagoposse.com/api/charts
